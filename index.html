<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>외래 통계 자동 계산 도구</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
  h1 { color: #2c3e50; }
  label { display: block; margin-top: 15px; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 6px 10px; text-align: center; }
  th { background-color: #f4f4f4; }
  #results { margin-top: 30px; white-space: nowrap; overflow-x: auto; }
  .section { margin-top: 40px; }
</style>
</head>
<body>
  <h1>외래 통계 자동 계산 도구</h1>
  <p>내원경로.xlsx, 외래환자.xlsx, 일일집계.xlsx 3개 파일을 모두 업로드하세요.</p>

  <label>내원경로.xlsx: <input type="file" id="fileNaewon" accept=".xlsx,.xls" /></label>
  <label>외래환자.xlsx: <input type="file" id="fileOerae" accept=".xlsx,.xls" /></label>
  <label>일일집계.xlsx: <input type="file" id="fileDaily" accept=".xlsx,.xls" /></label>

  <button id="btnProcess" disabled>통계 계산 시작</button>

  <div id="results"></div>

<script>
  const filesData = { naewon: null, oerae: null, daily: null };

  function handleFile(e, key) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const data = evt.target.result;
      const workbook = XLSX.read(data, { type: 'binary' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
      filesData[key] = jsonData;
      console.log(`${key} loaded`, jsonData);

      if (filesData.naewon && filesData.oerae && filesData.daily) {
        document.getElementById('btnProcess').disabled = false;
      }
    };
    reader.readAsBinaryString(file);
  }

  document.getElementById('fileNaewon').addEventListener('change', (e) => handleFile(e, 'naewon'));
  document.getElementById('fileOerae').addEventListener('change', (e) => handleFile(e, 'oerae'));
  document.getElementById('fileDaily').addEventListener('change', (e) => handleFile(e, 'daily'));

  function getGender(jumin) {
    try {
      jumin = jumin.toString().replace(/-/g, '').trim();
      if (jumin.length !== 13) return '무응답';
      const code = parseInt(jumin.charAt(6));
      return code % 2 === 1 ? '남' : '여';
    } catch {
      return '무응답';
    }
  }

  function calcAgeFromJumin(jumin) {
    try {
      jumin = jumin.toString().replace(/-/g, '').trim();
      if (jumin.length !== 13) return null;
      let year = parseInt(jumin.substring(0,2));
      const code = parseInt(jumin.charAt(6));
      if (code === 1 || code === 2 || code === 5 || code === 6) year += 1900;
      else year += 2000;
      const today = new Date();
      return today.getFullYear() - year + 1;
    } catch {
      return null;
    }
  }

  function ageGroup(age) {
    if (age === null) return '미상';
    if (age < 20) return '10대';
    if (age < 30) return '20대';
    if (age < 40) return '30대';
    if (age < 50) return '40대';
    if (age < 60) return '50대';
    if (age < 70) return '60대';
    return '70대 이상';
  }

  function createTable(title, headers, data) {
    let html = `<div class="section"><h2>${title}</h2><table><thead><tr>`;
    headers.forEach(h => { html += `<th>${h}</th>` });
    html += `</tr></thead><tbody>`;
    data.forEach(row => {
      html += `<tr>`;
      row.forEach(cell => {
        html += `<td>${cell}</td>`;
      });
      html += `</tr>`;
    });
    html += `</tbody></table></div>`;
    return html;
  }

  function sumArray(arr) {
    return arr.reduce((a,b) => a+b, 0);
  }

  document.getElementById('btnProcess').addEventListener('click', () => {
    const naewon = filesData.naewon;
    const oerae = filesData.oerae;
    const daily = filesData.daily;

    // 파일 로드 검증
    if (!naewon || !oerae || !daily) {
      alert('모든 파일을 업로드 해주세요.');
      return;
    }

    // 데이터 변수 세팅 (헤더 없는 상태 가정)

    // === 저장1: 주소별, 내원경로별, 연령별 성별 수납액 ===

    // 1) 내원경로.xlsx : A=0(내원경로), B=1(차트번호)
    const naewonMap = new Map();
    for(let i=1; i<naewon.length; i++) {
      const row = naewon[i];
      const chartNum = row[1] ? row[1].toString().trim() : '';
      const route = row[0] ? row[0].toString().trim() : '무응답';
      if(chartNum) naewonMap.set(chartNum, route);
    }

    // 2) 외래환자.xlsx : C=2(차트번호), E=4(주민번호), M=12(수납액)
    // 3) 일일집계.xlsx : C=2(차트번호), E=4(주민번호), J=9(신환/재진/90일초진), AD=29(접수일시)
    //    주민번호, 접수일시는 문자열로 처리

    // 주민번호 -> 성별, 연령, 연령대 계산 함수 사용

    // 외래환자 맵: 차트번호 -> 수납액(합계)
    const payMap = new Map();
    for(let i=1; i<oerae.length; i++) {
      const row = oerae[i];
      const chartNum = row[2] ? row[2].toString().trim() : '';
      const pay = Number(row[12]) || 0;
      if(chartNum) {
        payMap.set(chartNum, (payMap.get(chartNum) || 0) + pay);
      }
    }

    // 일일집계 주민번호와 환자구분 및 접수시간 매핑
    const dailyMap = new Map(); // 차트번호 -> {jumin, patientType, dateStr}
    for(let i=1; i<daily.length; i++) {
      const row = daily[i];
      const chartNum = row[2] ? row[2].toString().trim() : '';
      const jumin = row[4] ? row[4].toString().trim() : '';
      const patientTypeRaw = row[9] ? row[9].toString().trim() : '';
      const patientType = (patientTypeRaw === '신환' || patientTypeRaw === '90일초진') ? patientTypeRaw : '재진';
      const dateStr = row[29] ? row[29].toString().trim() : '';
      if(chartNum) {
        dailyMap.set(chartNum, { jumin, patientType, dateStr });
      }
    }

    // 저장1 계산: 내원경로 + 연령대 + 성별 + 수납액 통계
    // 집계 구조: { [내원경로]: { [연령대]: { 남: 금액, 여: 금액 } } }

    const stat1 = {};

    payMap.forEach((pay, chartNum) => {
      const route = naewonMap.get(chartNum) || '무응답';
      const dailyInfo = dailyMap.get(chartNum);
      if(!dailyInfo) return;

      const gender = getGender(dailyInfo.jumin);
      const age = calcAgeFromJumin(dailyInfo.jumin);
      const ageGrp = ageGroup(age);

      if(!stat1[route]) stat1[route] = {};
      if(!stat1[route][ageGrp]) stat1[route][ageGrp] = { 남:0, 여:0 };
      stat1[route][ageGrp][gender] += pay;
    });

    // 출력 테이블 데이터 만들기
    const stat1Rows = [];
    for(const route in stat1) {
      for(const ageGrp in stat1[route]) {
        stat1Rows.push([
          route,
          ageGrp,
          stat1[route][ageGrp].남.toLocaleString(),
          stat1[route][ageGrp].여.toLocaleString()
        ]);
      }
    }

    // === 저장2~4 계산 생략 (시간 관계상 먼저 저장1 샘플만 작성) ===

    // 결과 출력
    let html = '';
    html += createTable('저장1: 내원경로별 연령대별 성별 수납액', ['내원경로', '연령대', '남 수납액', '여 수납액'], stat1Rows);

    document.getElementById('results').innerHTML = html;
  });
</script>
</body>
</html>
